"use strict";(()=>{var e={};e.id=600,e.ids=[600],e.modules={11185:e=>{e.exports=require("mongoose")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},50287:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>y,originalPathname:()=>A,patchFetch:()=>v,requestAsyncStorage:()=>p,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>h});var a={};t.r(a),t.d(a,{DELETE:()=>c,POST:()=>d});var n=t(6170),s=t(8533),o=t(54387),i=t(40064),u=t(30611),l=t(24282);async function d(e){try{await (0,u.v)();let r=await e.json(),t=e.headers.get("authorization"),a=process.env.SYNC_SECRET_KEY||"default-sync-key";if(t!==`Bearer ${a}`)return i.Z.json({error:"Unauthorized"},{status:401});let n=await l.Z.findOneAndUpdate({telegramId:r.telegramId},{telegramId:r.telegramId,username:r.username,firstName:r.firstName,lastName:r.lastName,referredBy:r.referredBy,hasBeenCountedAsReferral:r.hasBeenCountedAsReferral,lastLikeAt:r.lastLikeAt,likedPlugs:r.likedPlugs,joinedAt:r.joinedAt,isAdmin:r.isAdmin},{upsert:!0,new:!0,runValidators:!0});return i.Z.json({success:!0,user:{_id:n._id,telegramId:n.telegramId,username:n.username}})}catch(e){return console.error("User sync error:",e),i.Z.json({error:"Failed to sync user"},{status:500})}}async function c(e){try{await (0,u.v)();let{telegramId:r}=await e.json(),t=e.headers.get("authorization"),a=process.env.SYNC_SECRET_KEY||"default-sync-key";if(t!==`Bearer ${a}`)return i.Z.json({error:"Unauthorized"},{status:401});return await l.Z.findOneAndDelete({telegramId:r}),i.Z.json({success:!0})}catch(e){return console.error("User delete error:",e),i.Z.json({error:"Failed to delete user"},{status:500})}}let m=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/users/sync/route",pathname:"/api/users/sync",filename:"route",bundlePath:"app/api/users/sync/route"},resolvedPagePath:"/workspace/web-app/app/api/users/sync/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:f,serverHooks:g,headerHooks:y,staticGenerationBailout:h}=m,A="/api/users/sync/route";function v(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},30611:(e,r,t)=>{t.d(r,{v:()=>i});var a=t(11185),n=t.n(a);let s=process.env.MONGODB_URI;if(!s)throw Error("Please define the MONGODB_URI environment variable");let o=global.mongoose||{conn:null,promise:null};async function i(){if(o.conn)return o.conn;o.promise||(o.promise=n().connect(s,{bufferCommands:!1}));try{o.conn=await o.promise}catch(e){throw o.promise=null,e}return o.conn}global.mongoose||(global.mongoose=o)},24282:(e,r,t)=>{t.d(r,{Z:()=>o});var a=t(11185),n=t.n(a);let s=new(n()).Schema({telegramId:{type:String,required:!0,unique:!0},username:String,firstName:String,lastName:String,referredBy:{type:n().Schema.Types.ObjectId,ref:"Plug"},hasBeenCountedAsReferral:{type:Boolean,default:!1},lastLikeAt:Date,likedPlugs:[{plugId:{type:n().Schema.Types.ObjectId,ref:"Plug"},likedAt:Date}],joinedAt:{type:Date,default:Date.now},isAdmin:{type:Boolean,default:!1}}),o=n().models.User||n().model("User",s)}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[864,386],()=>t(50287));module.exports=a})();